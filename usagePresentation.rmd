
# Dataset Downloads

Datasets at gbif are often downloaded through the [web interface](https://www.gbif.org/occurrence/search?q=), or through the api (via rgbif ect.). When a dataset is downloaded, this information is stored in a registry table called **occurrence_download**. 

Users can place various **filters** on the data in order to limit the number of records returned. As the occurrence index is currently a **447 GB** csv, most users want to use a filter. 

## Types of filters

There are many ways that a user can filter data. The types and combinations of filters are almost limitless. Below I describe some of the **most common** filters: 

**1. TAXON_KEY**

This is one of the most common filters users place on the gbif occurrence index. Users can either choose **one** or **many** taxon names to filter the data, and users can choose any taxon rank they want (species, genus, family, kingdom ect). 

**2. COUNTRY**

Here users can return records only from a certain country. This is the country the user searched and **not** where user is searching from. 

**3. HAS_GEOSPATIAL_ISSUE**

Here users can specify that they want occurrence records **without some interpreted error**. 

**4. HAS_COORDINATE**

Here users can say that they want occurrence records that **have coordinates**. 

**5. No Filter**

Finally, a surprising number of users never put any filter and instead request to download the **entire occurrence index**. In the overwhelming majority of cases, we have to assume these users have done this **by mistake**.

## Total monthly downloads

Here I plot the total monthly downloads for various popular filters. 

Two peaks in total downloads stand out: 

* Mar 2014
* Sep 2016 

The **Sep 2016** peak seems to be explained by high **DATASET_KEY** downloads. Both the **Mar 2014** and **Sep 2016** peaks are well explained by the **top users**. Top users in this graph are all the downloads generated by the **top 3 most active users** on GBIF. These users generate downloads in the 1000s and are most likely to be automated downloads generated internally. 

One interesting detail is that while **No Filter Used** is not used very often it accounts for more than **500 billion** occurrence records downloaded. 

Finally, if we look at the **number of unique users** (un-select everything else to see in isolation), we see that **the number of individuals making downloads on GBIF has been increasing steadily** with some perhaps interesting cyclical patterns. 

```{r, echo=FALSE, warning=FALSE,message=FALSE,fig.height=7,fig.width=10,cache=TRUE}
source("C:/Users/ftw712/Desktop/usageReport/R/highchartsTotalDownloadsAndFilter.r")
highchartsTotalDownloadsAndFilter()
```

## Global top filter combinations

Here are the top global filter combinations. Most downloads are generated using a **TAXON_KEY** filter or some variation including a TAXON_KEY. **DATASET_KEY** likely has such a high position in this graph because most automated downloads at GBIF are generated using dataset keys. As we saw in the previous graphic, over 12k downloads were generated automatically using a dataset key filter on **Sep 2016**. 

```{r, echo=FALSE, warning=FALSE,message=FALSE, fig.height=7,fig.width=10,cache=TRUE}
source("C:/Users/ftw712/Desktop/usageReport/R/trueGlobalTopFilterCombinations.r")
trueGlobalTopFilterCombinations()
```

## Number of records returned

The number of occurrence records returned for a download request varies depending on the filter. Not suprisingly the largest download requests occur when the user has simply not used a filter (**No Filter**). The second largest requests come from users simply searching for records with coordinates  and without issues 
(**HAS_COORDINATE** + **HAS_GEOSPATIAL_ISSUE**). Additionally, many large requests come from users entering a **TAXON_KEY** filter. For this dataset [AntWeb](https://www.gbif.org/dataset/13b70480-bd69-11dd-b15f-b8a03c50a862) it is probably users searching for Insecta or Animalia. 

```{r echo=FALSE, fig.height=7, message=FALSE, fig.width=10, cache=FALSE, warning=FALSE}
source("C:/Users/ftw712/Desktop/usageReport/R/highChartNumberOfRecordsReturnedByFilter.r")
File = "13b70480-bd69-11dd-b15f-b8a03c50a862.rda" # antWeb
highChartNumberOfRecordsReturnedByFilter(File,numToPlot=1000)
```

### Consistent bias in total downloads <span style="color:#bad744">**with**</span> and <span style="color:#5b8124">**without**</span> filter

From the plot below we see that the bias is fairly consistent, since choosing to download the entire dataset gives **1 extra download** to every dataset in gbif during that time. So it probably will not change the relatively ranking of the download statistics if we include or exclude **large-grab filters**. 

Interestingly we see that some datasets only get downloaded when **no filter is used**, which is seen at the bottom of this graph. 

```{r, echo=FALSE, warning=FALSE, fig.height=10, fig.width=10, cache=TRUE}
# dumbbell plot showing mostly stystematic bias in downloading whole dataset...
DS = read.table(file="C:/Users/ftw712/Desktop/usageStats/datasetSizes.csv",sep=",",header=TRUE) # dataset sizes

Files = list.files("C:/Users/ftw712/Desktop/usageStats/datasets/") #

numberHits = c() # number hits on databats
numberHitsWithFilter = c() # number of hits with a filter
for(i in 1:length(Files)) {
File = Files[i]
load(file=paste0("C:/Users/ftw712/Desktop/usageStats/datasets/",File))
numberHits[i] = nrow(D)
numberHitsWithFilter[i] = nrow(D[!is.na(D$filter),])
}

dataset_key = gsub(".rda","",Files)
D = data.frame(dataset_key,numberHits,numberHitsWithFilter)


# D$dataset_key = reorder(D$dataset_key, order(D$numberHits))

# point.colour.l = NULL, point.size.l = NULL, point.colour.r = NULL

D = D[order(D$numberHits),] # order to reorder factor levels 
D$dataset_key = factor(D$dataset_key, levels = D$dataset_key)

library(ggplot2)
library(ggthemes)
library(ggalt)

ggplot(D, aes(x=numberHits, xend=numberHitsWithFilter, y=dataset_key)) + 
geom_dumbbell(size = 2,color="#e3e2e1", colour_x = "#5b8124", colour_xend = "#bad744") + 
theme_minimal() + 
ylab("dataset key") + 
xlab("number of downloads with and without filter") + 
ggtitle("Number of downloads", subtitle = "Almost consistent bias in number of downloads with and without filter") 

```

## Are the number of downloads related to the number of occurrence records in the dataset?

Here we see that the number of downloads is roughly positively related to the total number of occurrence records in the dataset. **Larger datasets are getting downloaded more often.** 

Also in this plot is the mean percentage of the whole of GBIF when each download request was made. That is, for each download request made to a dataset, what percentage of GBIF was downloaded. We see that some **smaller datasets really only get downloaded when a large percentage of GBIF records were requested.** 


```{r, echo=FALSE, warning=FALSE, fig.width=10,fig.height=10}
load("C:/Users/ftw712/Desktop/usageStats/markdown_data/percentGbifNumHits.rda") 

library(ggthemes)
library(ggplot2)

ggplot(D, aes(numberrecords, numberHits)) + 
geom_point(aes(size=percentOfGbif)) + 
theme_minimal()  + 
xlab("number occ. records in dataset") + 
ylab("number of downloads of dataset") + 
ggtitle("Number Occ. Records and Number of Downloads", subtitle = "Using 39 random datasets. Each point is one dataset.") + 
guides(size=guide_legend(title="Mean fraction\nof GBIF\ndowloaded"))


```
















